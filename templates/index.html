{% extends "base.html" %} {% block title %}Configuration - Grist ‚Üí DS Sync{%
endblock %} {% block content %}

<div class="row">
  <div class="col-md-8">
    <h1>Configuration des connexions</h1>
    <p class="text-muted">
      Configurez vos tokens d'acc√®s pour Grist et D√©marches Simplifi√©es
    </p>

    <form method="POST" action="{{ url_for('configure') }}">
      <div class="card mb-4">
        <div class="card-header">
          <h5><i class="bi bi-shield-lock"></i> D√©marches Simplifi√©es</h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label for="ds_token" class="form-label">Token DS *</label>
            <input
              type="password"
              class="form-control"
              id="ds_token"
              name="ds_token"
              value="{{ config.ds_token }}"
              placeholder="Votre token DS"
              required
            />
            <div class="form-text">Token d'authentification pour l'API DS</div>
          </div>
          <div class="mb-3">
            <label for="instructeur_id" class="form-label"
              >ID Instructeur *</label
            >
            <input
              type="text"
              class="form-control"
              id="instructeur_id"
              name="instructeur_id"
              value="{{ config.instructeur_id }}"
              placeholder="ID de l'instructeur"
              required
            />
          </div>
          <div class="mb-3">
            <label for="demarche_number" class="form-label"
              >Num√©ro de d√©marche</label
            >
            <input
              type="number"
              class="form-control"
              id="demarche_number"
              name="demarche_number"
              value="{{ config.demarche_number }}"
              placeholder="Ex: 12345"
              min="1"
            />
            <div class="form-text">Num√©ro de la d√©marche DS √† utiliser</div>
          </div>
          <div class="mb-3">
            <button
              type="button"
              id="load-instructeurs"
              class="btn btn-outline-secondary w-100"
            >
              <i class="bi bi-people"></i> Charger les instructeurs de la
              d√©marche
            </button>
            <div id="instructeurs-loading" class="loading mt-2">
              <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Chargement...</span>
              </div>
              Chargement des instructeurs...
            </div>
            <div id="instructeurs-list" class="mt-3"></div>
          </div>
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-header">
          <h5><i class="bi bi-table"></i> Grist</h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label for="grist_token" class="form-label">Token Grist *</label>
            <input
              type="password"
              class="form-control"
              id="grist_token"
              name="grist_token"
              value="{{ config.grist_token }}"
              placeholder="Votre token Grist"
              required
            />
            <div class="form-text">
              Token d'authentification pour l'API Grist
            </div>
          </div>
          <div class="mb-3">
            <label for="grist_doc_id" class="form-label"
              >ID Document Grist *</label
            >
            <input
              type="text"
              class="form-control"
              id="grist_doc_id"
              name="grist_doc_id"
              value="{{ config.grist_doc_id }}"
              placeholder="ID du document Grist"
              required
            />
            <div class="form-text">
              Identifiant du document Grist √† utiliser
            </div>
          </div>
        </div>
      </div>

      <button type="submit" class="btn btn-primary btn-lg">
        <i class="bi bi-check-circle"></i> Sauvegarder la configuration
      </button>
    </form>
  </div>

  <div class="col-md-4">
    <div class="card">
      <div class="card-header">
        <h5><i class="bi bi-activity"></i> Test des connexions</h5>
      </div>
      <div class="card-body">
        <button id="test-connections" class="btn btn-info mb-3 w-100">
          <i class="bi bi-wifi"></i> Tester les connexions
        </button>

        <div id="loading" class="loading">
          <div class="spinner-border spinner-border-sm" role="status">
            <span class="visually-hidden">Chargement...</span>
          </div>
          Test en cours...
        </div>

        <div id="connection-results"></div>
      </div>
    </div>

    {% if config.ds_token and config.grist_token %}
    <div class="card mt-3">
      <div class="card-header">
        <h5><i class="bi bi-arrow-right-circle"></i> Prochaines √©tapes</h5>
      </div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <a href="{{ url_for('sync_page') }}" class="btn btn-success">
            <i class="bi bi-sync"></i> Configurer la synchronisation
          </a>

          <hr />

          <h6>üí° Automatisation</h6>
          <p class="text-muted small">
            Une fois votre synchronisation configur√©e, vous pourrez
            l'automatiser avec des t√¢ches planifi√©es en utilisant notre script
            en ligne de commande.
          </p>
          <details class="small">
            <summary class="text-primary" style="cursor: pointer">
              Voir les commandes CLI
            </summary>
            <div class="mt-2 p-2 bg-light rounded">
              <code>python sync_cli.py --create-config config.json</code><br />
              <code>python sync_cli.py --config config.json --dry-run</code
              ><br />
              <code>python sync_cli.py --config config.json</code>
            </div>
          </details>
        </div>
      </div>
    </div>
    {% endif %}

    <div class="card mt-3">
      <div class="card-header">
        <h5><i class="bi bi-info-circle"></i> Aide</h5>
      </div>
      <div class="card-body">
        <h6>O√π trouver les tokens ?</h6>
        <ul class="small">
          <li><strong>Token DS :</strong> Profil ‚Üí API ‚Üí G√©n√©rer un token</li>
          <li><strong>ID Instructeur :</strong> URL profil DS</li>
          <li><strong>Token Grist :</strong> Document ‚Üí Partage ‚Üí API</li>
          <li><strong>Doc ID Grist :</strong> URL du document</li>
        </ul>
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block scripts %}
<script>
  document
    .getElementById("test-connections")
    .addEventListener("click", function () {
      const button = this;
      const loading = document.getElementById("loading");
      const results = document.getElementById("connection-results");

      button.disabled = true;
      loading.style.display = "block";
      results.innerHTML = "";

      fetch("/test_connections")
        .then((response) => response.json())
        .then((data) => {
          loading.style.display = "none";
          button.disabled = false;

          let html = "";

          // Test Grist
          if (data.grist) {
            html += `<div class="connection-status ${
              data.grist.success ? "connection-success" : "connection-error"
            }">
                    <strong>Grist:</strong> ${
                      data.grist.success
                        ? "‚úÖ Connexion r√©ussie"
                        : "‚ùå √âchec de connexion"
                    }
                    ${
                      !data.grist.success
                        ? "<br><small>" +
                          JSON.stringify(data.grist.data) +
                          "</small>"
                        : ""
                    }
                </div>`;
          }

          // Test DS
          if (data.ds) {
            html += `<div class="connection-status ${
              data.ds.success ? "connection-success" : "connection-error"
            }">
                    <strong>DS:</strong> ${
                      data.ds.success
                        ? "‚úÖ Connexion r√©ussie"
                        : "‚ùå √âchec de connexion"
                    }
                    ${
                      !data.ds.success
                        ? "<br><small>" +
                          JSON.stringify(data.ds.data) +
                          "</small>"
                        : ""
                    }
                </div>`;
          }

          results.innerHTML = html;
        })
        .catch((error) => {
          loading.style.display = "none";
          button.disabled = false;
          results.innerHTML = `<div class="connection-status connection-error">
                <strong>Erreur:</strong> ${error.message}
            </div>`;
        });
    });

  // Gestion du chargement des instructeurs
  document
    .getElementById("load-instructeurs")
    .addEventListener("click", function () {
      const button = this;
      const loading = document.getElementById("instructeurs-loading");
      const listContainer = document.getElementById("instructeurs-list");
      const dsToken = document.getElementById("ds_token").value;
      const demarcheNumber = document.getElementById("demarche_number").value;

      // V√©rifier que les champs requis sont remplis
      if (!dsToken || !demarcheNumber) {
        listContainer.innerHTML = `<div class="alert alert-warning">
          <i class="bi bi-exclamation-triangle"></i> Veuillez d'abord renseigner le token DS et le num√©ro de d√©marche
        </div>`;
        return;
      }

      button.disabled = true;
      loading.style.display = "block";
      listContainer.innerHTML = "";

      fetch("/get_instructeurs")
        .then((response) => response.json())
        .then((data) => {
          loading.style.display = "none";
          button.disabled = false;

          if (data.success && data.instructeurs) {
            let html = `<div class="alert alert-info">
              <strong><i class="bi bi-info-circle"></i> ${data.total} instructeur(s) trouv√©(s)</strong>
            </div>
            <div class="list-group">`;

            data.instructeurs.forEach((instructeur) => {
              const groupesText = instructeur.groupes
                .map((g) => g.label)
                .join(", ");
              html += `<button
                type="button"
                class="list-group-item list-group-item-action instructeur-item"
                data-instructeur-id="${instructeur.id}"
                data-instructeur-email="${instructeur.email}">
                <div class="d-flex w-100 justify-content-between">
                  <h6 class="mb-1"><i class="bi bi-person"></i> ${instructeur.email}</h6>
                </div>
                <p class="mb-1"><strong>ID:</strong> <code>${instructeur.id}</code></p>
                ${
                  groupesText
                    ? `<small class="text-muted"><strong>Groupes:</strong> ${groupesText}</small>`
                    : ""
                }
              </button>`;
            });

            html += "</div>";
            listContainer.innerHTML = html;

            // Ajouter les gestionnaires d'√©v√©nements pour s√©lectionner un instructeur
            document.querySelectorAll(".instructeur-item").forEach((item) => {
              item.addEventListener("click", function () {
                const instructeurId = this.getAttribute("data-instructeur-id");
                const instructeurEmail =
                  this.getAttribute("data-instructeur-email");

                // Mettre √† jour le champ instructeur_id
                document.getElementById("instructeur_id").value = instructeurId;

                // Mettre en √©vidence l'√©l√©ment s√©lectionn√©
                document.querySelectorAll(".instructeur-item").forEach((i) => {
                  i.classList.remove("active");
                });
                this.classList.add("active");

                // Afficher une confirmation
                const confirmationMsg = `<div class="alert alert-success mt-2">
                  <i class="bi bi-check-circle"></i> Instructeur s√©lectionn√©: <strong>${instructeurEmail}</strong> (ID: ${instructeurId})
                </div>`;

                // Supprimer l'ancien message de confirmation s'il existe
                const oldConfirmation = document.querySelector(
                  "#instructeurs-list .alert-success"
                );
                if (oldConfirmation && !oldConfirmation.closest(".list-group")) {
                  oldConfirmation.remove();
                }

                // Ajouter le nouveau message apr√®s la liste
                listContainer.insertAdjacentHTML("beforeend", confirmationMsg);

                // Scroll vers le champ instructeur_id pour montrer la mise √† jour
                document
                  .getElementById("instructeur_id")
                  .scrollIntoView({ behavior: "smooth", block: "center" });
              });
            });
          } else {
            listContainer.innerHTML = `<div class="alert alert-danger">
              <i class="bi bi-exclamation-circle"></i> ${
                data.error || "Erreur lors du chargement des instructeurs"
              }
            </div>`;
          }
        })
        .catch((error) => {
          loading.style.display = "none";
          button.disabled = false;
          listContainer.innerHTML = `<div class="alert alert-danger">
            <i class="bi bi-exclamation-circle"></i> Erreur: ${error.message}
          </div>`;
        });
    });
</script>
{% endblock %}
