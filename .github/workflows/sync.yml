name: ğŸ”„ Drac Draaf Grist to DS Sync
# ğŸ“ Personnaliser le nom selon votre projet

env:
  PROJECT_NAME: annotations-drac-draaf
  # ğŸ¯ Personnaliser selon votre projet
  DEFAULT_LIMIT: 50
  # âš™ï¸ Ajuster selon vos besoins (max 500)
  
on:
  # â° Planification automatique
  schedule:
    - cron: '0 10 * * *'      # ğŸŒ… Une fois par jour Ã  10h
    # ğŸ•˜ Personnaliser selon vos besoins de synchronisation
    # Exemples :
    # - cron: '0 8,12,16 * * 1-5'  # ğŸ•—ğŸ•›ğŸ•“ 3 fois par jour
    # - cron: '*/30 9-17 * * 1-5'  # â±ï¸ Toutes les 30min, 9h-17h
    # - cron: '0 10 * * *'         # ğŸŒ… Une fois par jour Ã  10h
  
  # ğŸ® DÃ©clenchement manuel
  workflow_dispatch:
    inputs:
      limit:
        description: "ğŸ“Š Nombre max d'enregistrements Ã  traiter"
        required: false
        default: "50"
      dry_run:
        description: "ğŸ§ª Mode test (aucune modification)"
        required: false
        default: "false"

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r shared/requirements.txt
        
    - name: ğŸ”§ Create dynamic config
      env:
        # ğŸ” Secrets spÃ©cifiques au projet - Ã€ PERSONNALISER
        GRIST_TOKEN: ${{ secrets.DRAC_DRAAF_GRIST_TOKEN }}
        DS_TOKEN: ${{ secrets.DRAC_DRAAF_DS_TOKEN }}
        DS_INSTRUCTEUR_ID: ${{ secrets.DRAC_DRAAF_DS_INSTRUCTEUR_ID }}
      run: |
        # ğŸ“‹ Charger la config de base et injecter les secrets
        python3 -c "
        import json
        import os
        
        # ğŸ“– Charger config.json (sans les secrets)
        with open('projects/${{ env.PROJECT_NAME }}/config.json', 'r') as f:
            config = json.load(f)
        
        # ğŸ”‘ Injecter les secrets depuis les variables d'environnement
        config['grist_token'] = os.environ['GRIST_TOKEN']
        config['ds_token'] = os.environ['DS_TOKEN'] 
        config['ds_instructeur_id'] = os.environ['DS_INSTRUCTEUR_ID']
        
        # ğŸ›ï¸ ParamÃ¨tres depuis les inputs (si dÃ©clenchement manuel)
        limit = '${{ github.event.inputs.limit }}' or '${{ env.DEFAULT_LIMIT }}'
        dry_run = '${{ github.event.inputs.dry_run }}'.lower() == 'true'
        
        config['limit'] = int(limit)
        config['dry_run'] = dry_run
        
        # ğŸ’¾ Sauvegarder la config complÃ¨te temporairement
        with open('/tmp/runtime_config.json', 'w') as f:
            json.dump(config, f, indent=2)
        
        print(f'âœ… Config crÃ©Ã©e - Limite: {limit}, Dry run: {dry_run}')
        "
        
    - name: ğŸš€ Execute synchronization
      run: |
        cd shared
        python sync_cli.py --config /tmp/runtime_config.json --verbose
      
    - name: ğŸ“‹ Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: sync-logs-${{ env.PROJECT_NAME }}-${{ github.run_number }}
        path: |
          sync.log
          *.log
        retention-days: 7
        
    - name: ğŸš¨ Notify on failure (optionnel)
      if: failure()
      run: |
        echo "âš ï¸ Synchronisation Ã©chouÃ©e pour le projet ${{ env.PROJECT_NAME }}"
        echo "ğŸ“Š Consultez les logs dans les artifacts de cette exÃ©cution"
        # ğŸ’¬ Ici vous pourriez ajouter une notification Slack, email, etc.

    - name: ğŸ§¹ Clean up sensitive files
      if: always()
      run: |
        # ğŸ—‘ï¸ Nettoyer les fichiers contenant des secrets
        rm -f /tmp/runtime_config.json
        rm -f sync.log
