name: ğŸ”„ Drac Draaf Grist to DS Sync

env:
  PROJECT_NAME: annotations-drac-draaf
  # ğŸ¯ Nom du dossier projet
  DEFAULT_LIMIT: 50
  # âš™ï¸ Limite par dÃ©faut (max 500)
  
on:
  # â° Planification automatique
  schedule:
    - cron: '0 10 * * *'      # ğŸŒ… Une fois par jour Ã  10h
    # ğŸ•˜ Personnaliser selon vos besoins de synchronisation
    # Exemples :
    # - cron: '0 8,12,16 * * 1-5'  # ğŸ•—ğŸ•›ğŸ•“ 3 fois par jour, lun-ven
    # - cron: '*/30 9-17 * * 1-5'  # â±ï¸ Toutes les 30min, 9h-17h, lun-ven
    # - cron: '0 10 * * *'         # ğŸŒ… Une fois par jour Ã  10h
  
  # ğŸ® DÃ©clenchement manuel
  workflow_dispatch:
    inputs:
      limit:
        description: "ğŸ“Š Nombre max d'enregistrements Ã  traiter"
        required: false
        default: "50"
        type: string
      dry_run:
        description: "ğŸ§ª Mode test (aucune modification)"
        required: false
        default: false
        type: boolean

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r shared/requirements.txt
        
    - name: ğŸ”§ Create dynamic config
      env:
        # ğŸ” Secrets spÃ©cifiques au projet DRAC-DRAAF
        GRIST_TOKEN: ${{ secrets.DRAC_DRAAF_GRIST_TOKEN }}
        DS_TOKEN: ${{ secrets.DRAC_DRAAF_DS_TOKEN }}
        DS_INSTRUCTEUR_ID: ${{ secrets.DRAC_DRAAF_DS_INSTRUCTEUR_ID }}
      run: |
        # ğŸ”„ Remplacer les placeholders par les vrais secrets
        sed -i "s/{{ GRIST_TOKEN }}/$GRIST_TOKEN/g" projects/${{ env.PROJECT_NAME }}/config.json
        sed -i "s/{{ DS_TOKEN }}/$DS_TOKEN/g" projects/${{ env.PROJECT_NAME }}/config.json  
        sed -i "s/{{ DS_INSTRUCTEUR_ID }}/$DS_INSTRUCTEUR_ID/g" projects/${{ env.PROJECT_NAME }}/config.json
        
        # ğŸ›ï¸ Ajuster les paramÃ¨tres dynamiques
        limit="${{ github.event.inputs.limit || env.DEFAULT_LIMIT }}"
        dry_run="${{ github.event.inputs.dry_run == true }}"
        
        # ğŸ“ Mettre Ã  jour limit et dry_run dans le JSON
        python3 -c "
        import json
        with open('projects/${{ env.PROJECT_NAME }}/config.json', 'r+') as f:
            config = json.load(f)
            config['limit'] = int('$limit')
            config['dry_run'] = '$dry_run' == 'True'
            f.seek(0)
            json.dump(config, f, indent=2)
            f.truncate()
        print(f'âœ… Config finalisÃ©e - Limite: $limit, Dry run: $dry_run')
        "
        
    - name: ğŸš€ Execute synchronization
      run: |
        cd shared
        python sync_cli.py --config ../projects/${{ env.PROJECT_NAME }}/config.json --verbose
      
    - name: ğŸ“‹ Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: sync-logs-${{ env.PROJECT_NAME }}-${{ github.run_number }}
        path: |
          shared/sync.log
          shared/*.log
        retention-days: 7
        
    - name: ğŸš¨ Notify on failure (optionnel)
      if: failure()
      run: |
        echo "âš ï¸ Synchronisation Ã©chouÃ©e pour le projet ${{ env.PROJECT_NAME }}"
        echo "ğŸ“Š Consultez les logs dans les artifacts de cette exÃ©cution"
        echo "ğŸ” VÃ©rifiez aussi les secrets GitHub : DRAC_DRAAF_GRIST_TOKEN, DRAC_DRAAF_DS_TOKEN, DRAC_DRAAF_DS_INSTRUCTEUR_ID"
        # ğŸ’¬ Ici vous pourriez ajouter une notification Slack, email, etc.

    - name: ğŸ§¹ Clean up sensitive files
      if: always()
      run: |
        # ğŸ”„ Restaurer les placeholders dans le config pour sÃ©curitÃ©
        cd projects/${{ env.PROJECT_NAME }}
        sed -i "s/$GRIST_TOKEN/{{ GRIST_TOKEN }}/g" config.json || true
        sed -i "s/$DS_TOKEN/{{ DS_TOKEN }}/g" config.json || true  
        sed -i "s/$DS_INSTRUCTEUR_ID/{{ DS_INSTRUCTEUR_ID }}/g" config.json || true
        cd ../../shared
        rm -f sync.log *.log || true
